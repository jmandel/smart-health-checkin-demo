<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dr. Mandel's Family Medicine - New Patient Registration</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      color: white;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .header-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: #0284c7;
    }
    .clinic-name {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: #0f172a;
    }
    .subtitle {
      margin: 0 0 32px 0;
      color: #64748b;
      font-size: 16px;
    }
    .task-list {
      margin: 24px 0;
    }
    .task-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #cbd5e0;
      transition: all 0.3s;
    }
    .task-item.completed {
      background: #d1fae5;
      border-left-color: #10b981;
    }
    .task-status {
      font-size: 24px;
      min-width: 32px;
      text-align: center;
    }
    .task-details {
      flex: 1;
    }
    .task-title {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .task-description {
      font-size: 14px;
      color: #64748b;
    }
    .task-badge {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
    }
    .badge-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .badge-received {
      background: #d1fae5;
      color: #065f46;
    }

    /* SMART Check-in Button */
    .checkin-button {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 24px;
      background: white;
      border: 2px solid #0284c7;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #0284c7;
      cursor: pointer;
      transition: all 0.2s;
      margin: 24px 0 16px 0;
    }
    .checkin-button:hover:not(:disabled) {
      background: #0284c7;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
    }
    .checkin-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .checkin-button-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .checkin-button-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }
    .checkin-button-primary {
      font-size: 16px;
      font-weight: 600;
    }
    .checkin-button-secondary {
      font-size: 13px;
      font-weight: 400;
      opacity: 0.8;
    }

    .manual-link {
      text-align: center;
      font-size: 14px;
      color: #64748b;
    }
    .manual-link a {
      color: #0284c7;
      text-decoration: none;
    }
    .manual-link a:hover {
      text-decoration: underline;
    }

    /* Transaction Log */
    .transaction-log {
      margin-top: 32px;
      padding: 20px;
      background: #0f172a;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .log-title {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .log-badge {
      font-size: 11px;
      padding: 3px 8px;
      background: #1e293b;
      color: #64748b;
      border-radius: 4px;
      font-family: monospace;
    }
    .log-content {
      background: #1e293b;
      padding: 16px;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #cbd5e0;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-content pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Insurance Card Rendering */
    .insurance-card {
      background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin: 16px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .insurance-card-header {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    .insurance-card-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
    }
    .insurance-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      font-size: 13px;
    }
    .insurance-card-field {
      margin-bottom: 8px;
    }
    .insurance-card-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 2px;
    }
    .insurance-card-value {
      font-weight: 600;
    }

    .loader {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(2, 132, 199, 0.3);
      border-top-color: #0284c7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .success-banner {
      background: #d1fae5;
      border-left: 4px solid #10b981;
      padding: 16px;
      border-radius: 6px;
      margin: 20px 0;
      color: #065f46;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">DM</div>
      <h2 class="clinic-name">Dr. Mandel's Family Medicine</h2>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h1>New Patient Registration</h1>
      <p class="subtitle">Please complete your registration by providing the following information:</p>

      <div class="task-list" id="task-list">
        <div class="task-item" id="task-insurance">
          <div class="task-status">‚è≥</div>
          <div class="task-details">
            <div class="task-title">Insurance Information</div>
            <div class="task-description">Digital insurance card with coverage details</div>
          </div>
          <span class="task-badge badge-pending">Pending</span>
        </div>

        <div class="task-item" id="task-clinical">
          <div class="task-status">‚è≥</div>
          <div class="task-details">
            <div class="task-title">Clinical History</div>
            <div class="task-description">Health records, medications, and allergies</div>
          </div>
          <span class="task-badge badge-pending">Pending</span>
        </div>

        <div class="task-item" id="task-intake">
          <div class="task-status">‚è≥</div>
          <div class="task-details">
            <div class="task-title">Patient Intake Form</div>
            <div class="task-description">Basic demographics and health concerns</div>
          </div>
          <span class="task-badge badge-pending">Pending</span>
        </div>
      </div>

      <div id="success-content" style="display: none;"></div>

      <button class="checkin-button" id="btn-checkin" onclick="startCheckin()">
        <div class="checkin-button-icon">üõ°Ô∏è</div>
        <div class="checkin-button-text">
          <div class="checkin-button-primary">Share with SMART Health Check-in</div>
          <div class="checkin-button-secondary">Connect your health app to auto-fill these forms</div>
        </div>
      </button>

      <div class="manual-link">
        <a href="#" onclick="alert('Manual entry would open a 15-20 minute form process'); return false;">
          Or fill out forms manually (15-20 mins)
        </a>
      </div>

      <div class="transaction-log">
        <div class="log-header">
          <span class="log-title">System Transaction Log</span>
          <span class="log-badge">JSON</span>
        </div>
        <div class="log-content">
          <pre id="log-content">Waiting for request...</pre>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./shl.js"></script>
  <script>
  (async () => {
    // Check if this is a return context
    const isReturn = await SHL.maybeHandleReturn();
    if (isReturn) {
      return;
    }

    const logContent = document.getElementById('log-content');

    function appendLog(message, data = null) {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      let logEntry = `[${timestamp}] ${message}`;
      if (data) {
        logEntry += '\n' + JSON.stringify(data, null, 2);
      }
      logContent.textContent += '\n\n' + logEntry;
      logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
    }

    function markTaskCompleted(taskId, badge) {
      const task = document.getElementById(`task-${taskId}`);
      task.classList.add('completed');
      task.querySelector('.task-status').textContent = '‚úì';
      const badgeEl = task.querySelector('.task-badge');
      badgeEl.textContent = 'Received';
      badgeEl.className = 'task-badge badge-received';
    }

    function renderInsuranceCard(coverage, patient) {
      return `
        <div class="insurance-card">
          <div class="insurance-card-header">DIGITAL INSURANCE CARD</div>
          <div class="insurance-card-name">${patient?.name?.[0]?.text || 'Patient Name'}</div>
          <div class="insurance-card-details">
            <div class="insurance-card-field">
              <div class="insurance-card-label">Member ID</div>
              <div class="insurance-card-value">${coverage?.subscriberId || 'N/A'}</div>
            </div>
            <div class="insurance-card-field">
              <div class="insurance-card-label">Group Number</div>
              <div class="insurance-card-value">${coverage?.class?.find(c => c.type?.coding?.[0]?.code === 'group')?.value || 'N/A'}</div>
            </div>
            <div class="insurance-card-field">
              <div class="insurance-card-label">Plan Name</div>
              <div class="insurance-card-value">${coverage?.payor?.[0]?.display || 'Health Plan'}</div>
            </div>
            <div class="insurance-card-field">
              <div class="insurance-card-label">Date of Birth</div>
              <div class="insurance-card-value">${patient?.birthDate || 'N/A'}</div>
            </div>
          </div>
        </div>
      `;
    }

    window.startCheckin = async () => {
      const button = document.getElementById('btn-checkin');
      button.disabled = true;
      button.innerHTML = '<span class="loader"></span><span style="margin-left: 8px;">Opening check-in...</span>';

      appendLog('[Outgoing Request] Protocol: smart-health-data');

      // Build comprehensive request
      const items = [
        {
          id: 'coverage-1',
          type: 'fhir-profile',
          resourceType: 'Coverage',
          profile: 'http://hl7.org/fhir/us/insurance-card/StructureDefinition/C4DIC-Coverage'
        },
        {
          id: 'patient-1',
          type: 'fhir-profile',
          resourceType: 'Patient',
          profile: 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient'
        },
        {
          id: 'intake-questionnaire-1',
          type: 'fhir-questionnaire',
          questionnaire: {
            resourceType: 'Questionnaire',
            id: 'patient-intake',
            title: 'Patient Intake Form - Dr. Mandel\'s Clinic',
            status: 'active',
            item: [
              { linkId: '1', text: 'Full Name', type: 'string', required: true },
              { linkId: '2', text: 'Date of Birth', type: 'date', required: true },
              { linkId: '3', text: 'Primary Health Concerns', type: 'text', required: false },
              { linkId: '4', text: 'Current Medications', type: 'text', required: false },
              { linkId: '5', text: 'Known Allergies', type: 'string', required: false }
            ]
          }
        }
      ];

      appendLog('Request envelope prepared:', {
        items: items.map(i => ({ id: i.id, type: i.type, resourceType: i.resourceType }))
      });

      try {
        const result = await SHL.request(
          {
            digital: {
              requests: [{
                protocol: 'smart-health-data',
                data: { items }
              }]
            }
          },
          {
            checkinBase: ZTWRConfig.requester.checkin,
            clientName: "Dr. Mandel's Family Medicine"
          }
        );

        appendLog('[Response Received]', { status: 'success', itemCount: 'Processing...' });

        // Parse the payload
        const payload = JSON.parse(result.data);
        appendLog('Payload parsed successfully', {
          itemsReceived: payload.items.length
        });

        // Process items and mark tasks complete
        let coverage = null;
        let patient = null;

        payload.items.forEach((item, idx) => {
          appendLog(`[Item ${idx + 1}] ${item.label || 'Data'}`, item);

          // Mark tasks as complete based on requestIds
          if (item.requestIds.includes('coverage-1')) {
            markTaskCompleted('insurance');
            // Extract coverage data
            if (item.body?.resourceType === 'Coverage') {
              coverage = item.body;
            } else if (item.body?.entry) {
              coverage = item.body.entry.find(e => e.resource?.resourceType === 'Coverage')?.resource;
            }
          }
          if (item.requestIds.includes('patient-1')) {
            markTaskCompleted('clinical');
            // Extract patient data
            if (item.body?.resourceType === 'Patient') {
              patient = item.body;
            } else if (item.body?.entry) {
              patient = item.body.entry.find(e => e.resource?.resourceType === 'Patient')?.resource;
            }
          }
          if (item.requestIds.includes('intake-questionnaire-1')) {
            markTaskCompleted('intake');
          }
        });

        // Show success banner and render insurance card
        const successDiv = document.getElementById('success-content');
        let successHTML = '<div class="success-banner">‚úì Registration information received successfully!</div>';

        if (coverage && patient) {
          successHTML += renderInsuranceCard(coverage, patient);
        }

        successDiv.innerHTML = successHTML;
        successDiv.style.display = 'block';

        button.innerHTML = '<span>‚úì</span><span style="margin-left: 8px;">Registration Complete</span>';
        button.style.background = '#10b981';
        button.style.borderColor = '#10b981';
        button.style.color = 'white';

        appendLog('[Transaction Complete]', { status: 'All data received and validated' });

      } catch (error) {
        console.error('[Requester] Error:', error);
        appendLog('[ERROR]', { message: error.message });
        button.disabled = false;
        button.innerHTML = '<div class="checkin-button-icon">üõ°Ô∏è</div><div class="checkin-button-text"><div class="checkin-button-primary">Share with SMART Health Check-in</div><div class="checkin-button-secondary">Connect your health app to auto-fill these forms</div></div>';
        alert('Error: ' + error.message);
      }
    };

    appendLog('[System Ready]', { clinic: "Dr. Mandel's Family Medicine", status: 'Waiting for user action' });
  })();
  </script>
</body>
</html>
