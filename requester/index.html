<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Dr. Mandel's Family Medicine - New Patient Registration</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      color: white;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: #0284c7;
    }

    .clinic-name {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: #0f172a;
    }

    .subtitle {
      margin: 0 0 32px 0;
      color: #64748b;
      font-size: 16px;
    }

    .task-list {
      margin: 24px 0;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #cbd5e0;
      transition: all 0.3s;
    }

    .task-item.completed {
      background: #d1fae5;
      border-left-color: #10b981;
    }

    .task-status {
      font-size: 24px;
      min-width: 32px;
      text-align: center;
    }

    .task-details {
      flex: 1;
    }

    .task-title {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .task-description {
      font-size: 14px;
      color: #64748b;
    }

    .task-badge {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
    }

    .badge-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-received {
      background: #d1fae5;
      color: #065f46;
    }

    /* SMART Check-in Button */
    .checkin-button {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 24px;
      background: white;
      border: 2px solid #0284c7;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #0284c7;
      cursor: pointer;
      transition: all 0.2s;
      margin: 24px 0 16px 0;
    }

    .checkin-button:hover:not(:disabled) {
      background: #0284c7;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
    }

    .checkin-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .checkin-button-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .checkin-button-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .checkin-button-primary {
      font-size: 16px;
      font-weight: 600;
    }

    .checkin-button-secondary {
      font-size: 13px;
      font-weight: 400;
      opacity: 0.8;
    }

    .manual-link {
      text-align: center;
      font-size: 14px;
      color: #64748b;
    }

    .manual-link a {
      color: #0284c7;
      text-decoration: none;
    }

    .manual-link a:hover {
      text-decoration: underline;
    }

    /* Transaction Log */
    .transaction-log {
      margin-top: 32px;
      padding: 20px;
      background: #0f172a;
      border-radius: 8px;
      border: 1px solid #334155;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .log-title {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .log-badge {
      font-size: 11px;
      padding: 3px 8px;
      background: #1e293b;
      color: #64748b;
      border-radius: 4px;
      font-family: monospace;
    }

    .log-content {
      background: #1e293b;
      padding: 16px;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #cbd5e0;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .log-content pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Insurance Card Rendering */
    .insurance-card {
      background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin: 16px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .insurance-card-header {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .insurance-card-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .insurance-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      font-size: 13px;
    }

    .insurance-card-field {
      margin-bottom: 8px;
    }

    .insurance-card-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 2px;
    }

    .insurance-card-value {
      font-weight: 600;
    }

    .loader {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(2, 132, 199, 0.3);
      border-top-color: #0284c7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .success-banner {
      background: #d1fae5;
      border-left: 4px solid #10b981;
      padding: 16px;
      border-radius: 6px;
      margin: 20px 0;
      color: #065f46;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="logo">DM</div>
      <h2 class="clinic-name">Dr. Mandel's Family Medicine</h2>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h1>New Patient Registration</h1>
      <p class="subtitle">Please complete your registration by providing the following information:</p>

      <div class="task-list" id="task-list">
        <div class="task-item" id="task-insurance">
          <div class="task-status">‚è≥</div>
          <div class="task-details">
            <div class="task-title">Insurance Information</div>
            <div class="task-description">Digital insurance card with coverage details</div>
          </div>
          <span class="task-badge badge-pending">Pending</span>
        </div>

        <div class="task-item" id="task-clinical">
          <div class="task-status">‚è≥</div>
          <div class="task-details">
            <div class="task-title">Clinical History</div>
            <div class="task-description">Health records, medications, and allergies</div>
          </div>
          <span class="task-badge badge-pending">Pending</span>
        </div>

        <div class="task-item" id="task-intake">
          <div class="task-status">‚è≥</div>
          <div class="task-details">
            <div class="task-title">Patient Intake Form</div>
            <div class="task-description">Basic demographics and health concerns</div>
          </div>
          <span class="task-badge badge-pending">Pending</span>
        </div>
      </div>

      <div id="success-content" style="display: none;"></div>
      <div id="card-container"></div>

      <button class="checkin-button" id="btn-checkin" onclick="startCheckin()">
        <div class="checkin-button-icon">üõ°Ô∏è</div>
        <div class="checkin-button-text">
          <div class="checkin-button-primary">Share with SMART Health Check-in</div>
          <div class="checkin-button-secondary">Connect your health app to auto-fill these forms</div>
        </div>
      </button>

      <div class="manual-link">
        <a href="#" onclick="alert('Manual entry would open a 15-20 minute form process'); return false;">
          Or fill out forms manually (15-20 mins)
        </a>
      </div>

      <div class="transaction-log" id="log">
        <div class="log-header">
          <span class="log-title">System Transaction Log</span>
          <span class="log-badge">JSON</span>
        </div>
        <div class="log-content">
          <pre id="log-content">Waiting for request...</pre>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./shl.js"></script>
  <script>
    (async () => {
      // Check if this is a return context
      const isReturn = await SHL.maybeHandleReturn();
      if (isReturn) {
        return;
      }

      const logContent = document.getElementById('log-content');

      function appendLog(message, data = null) {
        const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
        let logEntry = `[${timestamp}] ${message}`;
        if (data) {
          logEntry += '\n' + JSON.stringify(data, null, 2);
        }
        logContent.textContent += '\n\n' + logEntry;
        logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
      }

      function markTaskCompleted(taskId, badge) {
        const task = document.getElementById(`task-${taskId}`);
        task.classList.add('completed');
        task.querySelector('.task-status').textContent = '‚úì';
        const badgeEl = task.querySelector('.task-badge');
        badgeEl.textContent = 'Received';
        badgeEl.className = 'task-badge badge-received';
      }

      function renderInsuranceCard(coverage, patient) {
        const card = document.createElement('div');
        card.className = 'insurance-card';

        const header = document.createElement('div');
        header.className = 'insurance-card-header';
        header.textContent = 'DIGITAL INSURANCE CARD';
        card.appendChild(header);

        const name = document.createElement('div');
        name.className = 'insurance-card-name';
        name.textContent = patient?.name?.[0]?.text || 'Patient Name';
        card.appendChild(name);

        const details = document.createElement('div');
        details.className = 'insurance-card-details';

        const addField = (label, value) => {
          const field = document.createElement('div');
          field.className = 'insurance-card-field';

          const labelDiv = document.createElement('div');
          labelDiv.className = 'insurance-card-label';
          labelDiv.textContent = label;

          const valueDiv = document.createElement('div');
          valueDiv.className = 'insurance-card-value';
          valueDiv.textContent = value;

          field.appendChild(labelDiv);
          field.appendChild(valueDiv);
          details.appendChild(field);
        };

        addField('Member ID', coverage?.subscriberId || 'N/A');
        addField('Group Number', coverage?.class?.find(c => c.type?.coding?.[0]?.code === 'group')?.value || 'N/A');
        addField('Plan Name', coverage?.payor?.[0]?.display || 'Health Plan');
        addField('Date of Birth', patient?.birthDate || 'N/A');

        card.appendChild(details);
        return card;
      }
      // Transaction Browser Logic
      const renderTransactionBrowser = (request, response) => {
        const logContainer = document.getElementById('log');
        logContainer.replaceChildren(); // Clear existing logs
        logContainer.className = 'transaction-browser';
        logContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;';

        const createSection = (title, data) => {
          const section = document.createElement('div');
          section.className = 'browser-section';
          section.style.cssText = 'background: #1e293b; border-radius: 8px; overflow: hidden; border: 1px solid #334155;';

          const header = document.createElement('div');
          header.style.cssText = 'padding: 10px 15px; background: #0f172a; border-bottom: 1px solid #334155; font-weight: 600; color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;';
          header.textContent = title;

          const content = document.createElement('pre');
          content.style.cssText = 'margin: 0; padding: 15px; overflow: auto; font-family: "Fira Code", monospace; font-size: 12px; color: #e2e8f0; max-height: 400px;';
          content.textContent = JSON.stringify(data, null, 2);

          section.appendChild(header);
          section.appendChild(content);
          return section;
        };

        logContainer.appendChild(createSection('Request (OID4VP)', request));
        logContainer.appendChild(createSection('Response (OID4VP)', response));
      };

      window.startCheckin = async () => {
        const button = document.getElementById('btn-checkin');
        button.disabled = true;
        button.textContent = '';
        const loader = document.createElement('span');
        loader.className = 'loader';
        const text = document.createElement('span');
        text.style.marginLeft = '8px';
        text.textContent = 'Opening check-in...';
        button.appendChild(loader);
        button.appendChild(text);

        // Log the actual DCQL query we are about to send
        const dcqlQuery = {
          credentials: [
            {
              id: 'coverage-1',
              format: 'smart_artifact',
              optional: true,
              require_cryptographic_holder_binding: false,
              meta: {
                profile: 'http://hl7.org/fhir/us/insurance-card/StructureDefinition/C4DIC-Coverage'
              }
            },
            {
              id: 'patient-1',
              format: 'smart_artifact',
              optional: true,
              require_cryptographic_holder_binding: false,
              meta: {
                profile: 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient'
              }
            },
            {
              id: 'intake-questionnaire-1',
              format: 'smart_artifact',
              optional: true,
              require_cryptographic_holder_binding: false,
              meta: {
                questionnaire: {
                  resourceType: 'Questionnaire',
                  id: 'patient-intake',
                  title: 'Patient Intake Form - Dr. Mandel\'s Clinic',
                  status: 'active',
                  item: [
                    { linkId: '1', text: 'Full Name', type: 'string', required: true },
                    { linkId: '2', text: 'Date of Birth', type: 'date', required: true },
                    { linkId: '3', text: 'Primary Health Concerns', type: 'text', required: false },
                    { linkId: '4', text: 'Current Medications', type: 'text', required: false },
                    { linkId: '5', text: 'Known Allergies', type: 'string', required: false }
                  ]
                }
              }
            }
          ]
        };

        try {
          // Render request immediately once parameters are known
          let pendingRequestLog = null;
          const result = await SHL.request(
            dcqlQuery,
            {
              checkinBase: ZTWRConfig.requester.checkin,
              onRequestStart: (params) => {
                const sanitized = { ...params };
                delete sanitized.protocol;
                pendingRequestLog = sanitized;
                renderTransactionBrowser(sanitized, { status: 'Waiting for response...' });
                appendLog('[Request Sent]', sanitized);
              }
            }
          );

          // Parse the payload (response is now direct, not wrapped)
          const fullResponse = result;

          // Construct a richer request log with protocol parameters
          const redirectUri = new URL(location.href);
          redirectUri.hash = '';
          const redirectUriStr = redirectUri.toString();
          const requestLog = pendingRequestLog || {
            client_id: `redirect_uri:${redirectUriStr}`,
            response_type: 'vp_token',
            response_mode: 'fragment',
            state: fullResponse.state,
            dcql_query: dcqlQuery
          };

          // Render Transaction Browser
          renderTransactionBrowser(requestLog, fullResponse);

          // Use rehydrated credentials from shl.js
          console.log('[Requester] Full Response:', fullResponse);

          // Process credentials for UI
          let coverage = null;
          let patient = null;

          // Iterate over all credentials (already rehydrated by shl.js)
          if (fullResponse.credentials) {
            for (const [requestId, items] of Object.entries(fullResponse.credentials)) {
              console.log(`[Requester] Processing request ${requestId}:`, items);
              items.forEach(credential => {
                console.log('[Requester] Checking credential:', credential.resourceType);
                if (credential.resourceType === 'Coverage') {
                  coverage = credential;
                  console.log('[Requester] Found Coverage, marking insurance complete');
                  markTaskCompleted('insurance');
                }
                if (credential.resourceType === 'Patient') {
                  patient = credential;
                  console.log('[Requester] Found Patient, marking clinical complete');
                  markTaskCompleted('clinical');
                }
                if (credential.resourceType === 'QuestionnaireResponse') {
                  console.log('[Requester] Found QuestionnaireResponse, marking intake complete');
                  markTaskCompleted('intake');
                }
              });
            }
          }

          // Show success banner and render insurance card
          const successDiv = document.getElementById('success-content');
          successDiv.replaceChildren();
          const banner = document.createElement('div');
          banner.className = 'success-banner';
          banner.textContent = '‚úì Registration information received successfully!';
          successDiv.appendChild(banner);
          successDiv.style.display = 'block';

          if (coverage && patient) {
            const card = renderInsuranceCard(coverage, patient);
            const container = document.getElementById('card-container');
            container.replaceChildren();
            container.appendChild(card);
          }

          // Update button state
          button.disabled = false;
          button.textContent = '';
          const icon = document.createElement('div');
          icon.className = 'checkin-button-icon';
          icon.textContent = '‚úì';

          const doneText = document.createElement('div');
          doneText.className = 'checkin-button-text';
          doneText.innerHTML = '<div style="font-weight:600">Registration Complete</div><div style="font-size:12px;opacity:0.9">Data received</div>';

          button.appendChild(icon);
          button.appendChild(doneText);
          button.style.background = '#10b981';
          button.style.borderColor = '#10b981';
          button.style.color = 'white';

        } catch (error) {
          console.error('[Requester] Error:', error);
          // appendLog('[ERROR]', { message: error.message }); // Log removed, using alert/console for now
          const logContainer = document.getElementById('log');
          logContainer.innerHTML = `<div style="color: #ef4444; padding: 20px; background: #450a0a; border-radius: 8px;">Error: ${error.message}</div>`;

          button.disabled = false;
          button.textContent = '';
          const icon = document.createElement('div');
          icon.className = 'checkin-button-icon';
          icon.textContent = 'üõ°Ô∏è';

          const textContainer = document.createElement('div');
          textContainer.className = 'checkin-button-text';
          textContainer.innerHTML = '<div style="font-weight:600">Register with Health Wallet</div><div style="font-size:12px;opacity:0.9">SMART Health Check-in</div>';

          button.appendChild(icon);
          button.appendChild(textContainer);
          alert('Error: ' + error.message);
        }
      };

      appendLog('[System Ready]', { clinic: "Dr. Mandel's Family Medicine", status: 'Waiting for user action' });
    })();
  </script>
</body>

</html>
