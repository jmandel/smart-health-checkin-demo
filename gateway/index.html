<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ZTWR Gateway - Choose Your Health Data Source</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #0f172a;
      min-height: 100vh;
    }
    header {
      padding: 32px 20px;
      text-align: center;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
    }
    .subtitle {
      margin-top: 8px;
      font-size: 15px;
      color: #64748b;
    }
    main {
      padding: 32px 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .request-info {
      padding: 20px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      margin-bottom: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .request-info h2 {
      margin: 0 0 12px 0;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .request-info .detail {
      margin: 8px 0;
      font-size: 14px;
    }
    .request-info .label {
      color: #64748b;
      margin-right: 8px;
    }
    .request-info .value {
      color: #0f172a;
      font-family: monospace;
      font-size: 13px;
    }
    .apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    .card {
      padding: 24px;
      border: 2px solid transparent;
      border-radius: 16px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--brand-color);
    }
    .card:hover {
      border-color: var(--brand-color);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .card:active {
      transform: translateY(-2px);
    }
    .card-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--brand-color);
      color: white;
      font-size: 36px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .card-name {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }
    .card-desc {
      font-size: 14px;
      color: #64748b;
      line-height: 1.6;
    }
    .error {
      padding: 20px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      color: #991b1b;
    }
    .loading {
      padding: 40px;
      text-align: center;
      color: #64748b;
    }
  </style>
</head>
<body>
  <header>
    <h1>Choose Your Health Data Source</h1>
    <div class="subtitle">Select where to retrieve your health information</div>
  </header>
  <main>
    <div class="request-info" id="request-info" style="display:none;">
      <h2>Request Details</h2>
      <div class="detail">
        <span class="label">Protocol:</span>
        <span class="value" id="protocol"></span>
      </div>
      <div class="detail">
        <span class="label">Return to:</span>
        <span class="value" id="returnUrl"></span>
      </div>
    </div>

    <div id="apps" class="apps"></div>
    <div id="loading" class="loading">Loading health data sources...</div>
    <div id="error" class="error" style="display:none;"></div>
  </main>

  <script src="./config.js"></script>
  <script>
  (() => {
    const td = new TextDecoder();

    // Base64url decode
    const ub64 = (s) => {
      const pad = s.length % 4 ? '='.repeat(4 - (s.length % 4)) : '';
      const b64 = s.replace(/-/g, '+').replace(/_/g, '/') + pad;
      const bin = atob(b64);
      const a = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) a[i] = bin.charCodeAt(i);
      return a.buffer;
    };

    const decJ = (s) => JSON.parse(td.decode(ub64(s)));

    // Parse request from hash
    const reqB64 = new URLSearchParams(location.hash.slice(1)).get('req');
    if (!reqB64) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Missing request parameter. This page should be opened by the ZTWR library.';
      return;
    }

    let req;
    try {
      req = decJ(reqB64); // { v, state, returnUrl, digital: { requests: [...] }, recip_pub? }
      console.log('[Gateway] Request:', req);

      // Show request info - extract protocol from first request
      const protocol = req.digital?.requests?.[0]?.protocol || 'unknown';
      document.getElementById('protocol').textContent = protocol;
      document.getElementById('returnUrl').textContent = req.returnUrl;
      document.getElementById('request-info').style.display = 'block';
    } catch (e) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Invalid request format: ' + e.message;
      return;
    }

    // Load apps from config
    const apps = ZTWRConfig.gateway.apps;
    document.getElementById('loading').style.display = 'none';

    if (!apps || apps.length === 0) {
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'No health data sources available.';
      return;
    }

    const el = document.getElementById('apps');
    apps.forEach(app => {
          const card = document.createElement('div');
          card.className = 'card';

          // Set brand color as CSS variable
          if (app.color) {
            card.style.setProperty('--brand-color', app.color);
          }

          // Add logo
          if (app.logo) {
            const logo = document.createElement('div');
            logo.className = 'card-logo';
            logo.textContent = app.logo;
            card.appendChild(logo);
          }

          const name = document.createElement('div');
          name.className = 'card-name';
          name.textContent = app.name || app.id;

          const desc = document.createElement('div');
          desc.className = 'card-desc';
          desc.textContent = app.description || 'Health data source';

          card.appendChild(name);
          card.appendChild(desc);

          card.onclick = () => {
            console.log('[Gateway] Launching app:', app.id);

            // Pass through the digital credentials request structure
            const te = new TextEncoder();
            const b64u = (buf) => {
              const bin = String.fromCharCode(...new Uint8Array(buf));
              return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            };

            const handoffEnvelope = {
              v: 1,
              state: req.state,
              returnUrl: req.returnUrl,
              digital: req.digital
              // plus recip_pub if E2E enabled
            };

            const handoff = 'req=' + encodeURIComponent(b64u(te.encode(JSON.stringify(handoffEnvelope))));

            // Launch the health data source with handoff data
            const launchUrl = app.launchBase + '#' + handoff;
            console.log('[Gateway] Launch URL:', launchUrl);

            const w = window.open(launchUrl, '_blank');
            if (!w) {
              // Fallback: navigate this window
              console.warn('[Gateway] Popup blocked, navigating gateway window');
              location.href = launchUrl;
            } else {
              // Close this gateway tab immediately
              try {
                window.close();
              } catch (e) {
                // If we can't close, show feedback
                el.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">' +
                  '<div style="font-size:24px;margin-bottom:12px">âœ“</div>' +
                  '<div>Health data source opened</div>' +
                  '<div style="font-size:14px;margin-top:12px">You can close this tab.</div>' +
                  '</div>';
              }
            }
          };

          el.appendChild(card);
        });
  })();
  </script>
</body>
</html>
