<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>SMART Health Check-in - Choose Your Health Data Source</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: #f8fafc;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 32px 20px;
      text-align: center;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .shield-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      color: #0f172a;
    }

    .subtitle {
      margin-top: 8px;
      font-size: 15px;
      color: #64748b;
    }

    main {
      flex: 1;
      padding: 32px 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 32px 0 16px 0;
    }

    .section-title:first-child {
      margin-top: 0;
    }

    .apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      padding: 24px;
      border: 2px solid transparent;
      border-radius: 16px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--brand-color);
    }

    .card:hover {
      border-color: var(--brand-color);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .card:active {
      transform: translateY(-2px);
    }

    .card-logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: var(--brand-color);
      color: white;
      font-size: 28px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card-name {
      font-size: 17px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 6px;
    }

    .card-desc {
      font-size: 13px;
      color: #64748b;
      line-height: 1.5;
    }

    footer {
      padding: 24px 20px;
      text-align: center;
      background: white;
      border-top: 1px solid #e2e8f0;
      color: #64748b;
      font-size: 13px;
    }

    footer .footer-title {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .error {
      padding: 20px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      color: #991b1b;
    }

    .loading {
      padding: 40px;
      text-align: center;
      color: #64748b;
    }

    .requester-name {
      font-weight: 700;
      color: #0284c7;
    }
  </style>
</head>

<body>
  <header>
    <div class="shield-icon">üõ°Ô∏è</div>
    <h1 id="header-title">Choose Your Health Data Source</h1>
    <div class="subtitle" id="subtitle">Select where to retrieve your health information</div>
  </header>
  <main>
    <div id="content">
      <div id="loading" class="loading">Loading health data sources...</div>
      <div id="error" class="error" style="display:none;"></div>
    </div>
  </main>
  <footer>
    <div class="footer-title">Secure Routing by SMART Health Check-in</div>
    <div>We do not store your data</div>
  </footer>

  <script src="./config.js"></script>
  <script>
    (() => {

      // Parse request
      // Check for OID4VP Query Params first
      const urlParams = new URLSearchParams(window.location.search);
      const protocol = urlParams.get('protocol') || 'smart-health-checkin-v1';

      let req;

      if (protocol === 'smart-health-checkin-v1' || urlParams.get('response_type') === 'vp_token') {
        try {
          const clientIdRaw = urlParams.get('client_id');
          const responseType = urlParams.get('response_type');
          const responseMode = urlParams.get('response_mode');
          const nonce = urlParams.get('nonce');
          const state = urlParams.get('state');

          req = {
            protocol: 'smart-health-checkin-v1',
            client_id: clientIdRaw,
            response_type: responseType,
            response_mode: responseMode,
            nonce: nonce,
            state: state,
            dcql_query: JSON.parse(urlParams.get('dcql_query') || '{}')
          };
          console.log('[Check-in] Request (OID4VP):', req);
        } catch (e) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').style.display = 'block';
          document.getElementById('error').textContent = 'Invalid OID4VP request: ' + e.message;
          return;
        }
      } else {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'Missing request parameter. This page should be opened by the SMART Health Check-in library.';
        return;
      }

      // Load apps from config
      const apps = ZTWRConfig.checkin.apps;
      document.getElementById('loading').style.display = 'none';

      if (!apps || apps.length === 0) {
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'No health data sources available.';
        return;
      }

      // Group apps by category
      const categories = {
        'ehr': { title: 'Health Systems', apps: [] },
        'phr': { title: 'Connected Apps', apps: [] },
        'healthplan': { title: 'Health Plans', apps: [] }
      };

      apps.forEach(app => {
        const category = app.category || 'phr';
        if (categories[category]) {
          categories[category].apps.push(app);
        } else {
          categories.phr.apps.push(app);
        }
      });

      // Render apps by category
      const contentEl = document.getElementById('content');
      contentEl.textContent = '';

      Object.entries(categories).forEach(([key, category]) => {
        if (category.apps.length === 0) return;

        const sectionTitle = document.createElement('div');
        sectionTitle.className = 'section-title';
        sectionTitle.textContent = category.title;
        contentEl.appendChild(sectionTitle);

        const appsGrid = document.createElement('div');
        appsGrid.className = 'apps';

        category.apps.forEach(app => {
          const card = document.createElement('div');
          card.className = 'card';

          // Disable non-Flexpa apps (example only)
          const isDisabled = app.id !== 'flexpa';
          if (isDisabled) {
            card.classList.add('disabled');
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
          }

          // Set brand color as CSS variable
          if (app.color) {
            card.style.setProperty('--brand-color', app.color);
          }

          // Add logo
          if (app.logo) {
            const logo = document.createElement('div');
            logo.className = 'card-logo';
            logo.textContent = app.logo;
            card.appendChild(logo);
          }

          const name = document.createElement('div');
          name.className = 'card-name';
          name.textContent = app.name || app.id;

          const desc = document.createElement('div');
          desc.className = 'card-desc';
          desc.textContent = isDisabled ? '(Example - Click Flexpa above)' : (app.description || 'Health data source');

          card.appendChild(name);
          card.appendChild(desc);

          // Only allow clicking on Flexpa
          if (!isDisabled) {
            card.onclick = () => {
              console.log('[Check-in] Launching app:', app.id);

              const appParams = new URLSearchParams();
              if (req.protocol === 'smart-health-checkin-v1') {
                appParams.set('client_id', req.client_id);

                appParams.set('response_type', 'vp_token');
                appParams.set('response_mode', 'fragment');
                appParams.set('state', req.state);
                appParams.set('nonce', req.nonce);
                appParams.set('dcql_query', JSON.stringify(req.dcql_query));

                const launchUrl = app.launchBase + '?' + appParams.toString();
                console.log('[Check-in] Launch URL (OID4VP):', launchUrl);

                const w = window.open(launchUrl, '_blank');
                if (!w) {
                  console.warn('[Check-in] Popup blocked, navigating check-in window');
                  location.href = launchUrl;
                } else {
                  try { window.close(); } catch (e) { }
                }
                return;
              }
            };
          }

          appsGrid.appendChild(card);
        });

        contentEl.appendChild(appsGrid);
      });
    })();
  </script>
</body>

</html>
