<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Flexpa - Health Data Access</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #0d9488 0%, #84cc16 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: rgba(255, 255, 255, 0.98);
      color: #0f172a;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .logo {
      display: flex;
      gap: 2px;
      margin-bottom: 16px;
      justify-content: center;
    }
    .pixel {
      width: 12px;
      height: 12px;
      background: #0d9488;
    }
    .pixel:nth-child(4), .pixel:nth-child(5) {
      background: #84cc16;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      text-align: center;
      color: #0d9488;
      font-weight: 700;
    }
    .subtitle {
      text-align: center;
      color: #64748b;
      font-size: 14px;
      margin-bottom: 24px;
    }
    .request-box {
      background: #f1f5f9;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .request-box h2 {
      margin: 0 0 12px 0;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .request-detail {
      margin: 6px 0;
      font-size: 13px;
    }
    .label {
      color: #64748b;
      font-weight: 500;
    }
    .value {
      color: #1e293b;
      font-family: monospace;
      font-size: 12px;
    }
    .request-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      font-size: 12px;
    }
    .request-item-type {
      font-weight: 600;
      color: #0d9488;
      margin-bottom: 4px;
    }
    .section {
      margin: 20px 0;
    }
    .section h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #0d9488;
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #334155;
      transition: background 0.15s;
    }
    label:hover {
      background: #f1f5f9;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #0d9488;
      cursor: pointer;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .card-preview {
      background: white;
      border: 2px solid #0d9488;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 2px 8px rgba(13, 148, 136, 0.1);
    }
    .card-preview h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #0d9488;
      font-weight: 600;
    }
    .card-info {
      font-size: 13px;
      line-height: 1.6;
      color: #475569;
    }
    .card-info div {
      margin: 4px 0;
    }
    .questionnaire-form {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }
    .questionnaire-item {
      margin: 16px 0;
    }
    .questionnaire-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1e293b;
    }
    .auto-filled-banner {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .auto-filled-banner-icon {
      font-size: 24px;
    }
    .auto-filled-banner-text {
      flex: 1;
      color: #92400e;
      font-weight: 600;
      font-size: 14px;
    }
    .auto-filled-field {
      background: #fef3c7 !important;
      border-color: #fbbf24 !important;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #0d9488;
      color: white;
    }
    .btn-primary:hover {
      background: #0f766e;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    }
    .btn-primary:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }
    .btn-secondary:hover {
      background: #cbd5e0;
    }
    .note {
      font-size: 12px;
      color: #64748b;
      margin-top: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <div class="pixel"></div>
      <div class="pixel"></div>
      <div class="pixel"></div>
      <div class="pixel"></div>
      <div class="pixel"></div>
      <div class="pixel"></div>
    </div>
    <h1>Flexpa</h1>
    <div class="subtitle">Building blocks of health data</div>

    <div id="content">
      <!-- Will be populated by JavaScript -->
    </div>
  </div>

  <script>
  (() => {
    const te = new TextEncoder();
    const td = new TextDecoder();
    const b64u = (buf) => {
      const bin = String.fromCharCode(...new Uint8Array(buf));
      return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    };

    const ub64 = (s) => {
      const pad = s.length % 4 ? '='.repeat(4 - (s.length % 4)) : '';
      const b64 = s.replace(/-/g, '+').replace(/_/g, '/') + pad;
      const bin = atob(b64);
      const a = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) a[i] = bin.charCodeAt(i);
      return a.buffer;
    };

    const decJ = (s) => JSON.parse(td.decode(ub64(s)));

    // Parse Navigator Credentials request from hash
    const params = new URLSearchParams(location.hash.slice(1));
    const reqB64 = params.get('req');

    if (!reqB64) {
      document.getElementById('content').innerHTML = '<div style="text-align:center;color:#dc2626;padding:40px">Invalid request parameters</div>';
      return;
    }

    let req;
    try {
      req = decJ(reqB64); // { v, state, returnUrl, digital: { requests: [...] } }
    } catch (e) {
      document.getElementById('content').innerHTML = '<div style="text-align:center;color:#dc2626;padding:40px">Invalid request format</div>';
      return;
    }

    const state = req.state;
    const returnUrl = req.returnUrl;
    const protocol = req.digital?.requests?.[0]?.protocol || 'Not specified';
    const requestItems = req.digital?.requests?.[0]?.data?.items || [];

    if (!state || !returnUrl) {
      document.getElementById('content').innerHTML = '<div style="text-align:center;color:#dc2626;padding:40px">Invalid request parameters</div>';
      return;
    }

    console.log('[Flexpa] Request:', { protocol, state, returnUrl, requestItems });

    // Render UI based on request items
    let html = `
      <div class="request-box">
        <h2>Share Request</h2>
        <div class="request-detail">
          <div class="label">Protocol:</div>
          <div class="value">${protocol}</div>
        </div>
        <div class="request-detail">
          <div class="label">Requesting site:</div>
          <div class="value">${returnUrl}</div>
        </div>
        <div class="request-detail">
          <div class="label">Requested items (${requestItems.length}):</div>
          ${requestItems.map(item => `
            <div class="request-item">
              <div class="request-item-type">${item.type === 'fhir-profile' ? 'üìã Profile' : 'üìù Questionnaire'}: ${item.id}</div>
              <div class="value">${item.profile || item.questionnaireUrl || 'Inline questionnaire'}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;

    // Show selection checkboxes for what was requested
    html += `<div class="section"><h3>Select Data to Share</h3><div class="note">Choose which requested items to share with the provider</div>`;

    // Check for insurance/coverage requests
    const hasCoverageRequest = requestItems.some(item =>
      item.type === 'fhir-profile' && item.resourceType === 'Coverage'
    );
    if (hasCoverageRequest) {
      html += `
        <label style="display:flex;align-items:flex-start;gap:12px;padding:16px;background:white;border:2px solid #e2e8f0;border-radius:8px;margin:12px 0;cursor:pointer;">
          <input type="checkbox" id="share-insurance" checked style="margin-top:4px">
          <div style="flex:1">
            <div style="font-weight:600;color:#0d9488;margin-bottom:8px">üìã Insurance Card</div>
            <div class="card-preview" style="margin:0">
              <div class="card-info">
                <div><strong>Member:</strong> Jane Doe</div>
                <div><strong>Member ID:</strong> W123456789</div>
                <div><strong>Plan:</strong> Aetna PPO</div>
              </div>
            </div>
          </div>
        </label>
      `;
    }

    // Check for clinical/patient requests
    const hasClinicalRequest = requestItems.some(item =>
      item.type === 'fhir-profile' && item.resourceType === 'Patient'
    );
    if (hasClinicalRequest) {
      html += `
        <label style="display:flex;align-items:flex-start;gap:12px;padding:16px;background:white;border:2px solid #e2e8f0;border-radius:8px;margin:12px 0;cursor:pointer;">
          <input type="checkbox" id="share-clinical" checked style="margin-top:4px">
          <div style="flex:1">
            <div style="font-weight:600;color:#0d9488;margin-bottom:8px">üè• Clinical Summary</div>
            <div style="font-size:13px;color:#64748b">Health records including medications, allergies, conditions, and vital signs</div>
          </div>
        </label>
      `;
    }

    html += `</div>`;

    // Check for questionnaire requests
    const questionnaireItems = requestItems.filter(item => item.type === 'fhir-questionnaire');
    if (questionnaireItems.length > 0) {
      html += `<div class="section">`;
      questionnaireItems.forEach((qItem, idx) => {
        const questionnaire = qItem.questionnaire;
        const title = questionnaire?.title || qItem.id;

        // Generate random pre-filled values
        const randomNames = ['Jane Doe', 'John Smith', 'Maria Garcia', 'James Johnson'];
        const randomDates = ['1985-06-15', '1990-03-22', '1978-11-30', '1995-08-14'];
        const randomConcerns = [
          'Occasional headaches and fatigue',
          'Managing blood pressure',
          'Seasonal allergies',
          'No specific concerns at this time'
        ];
        const randomMeds = [
          'Lisinopril 10mg daily for blood pressure',
          'Metformin 500mg twice daily',
          'Levothyroxine 50mcg daily',
          'No current medications'
        ];
        const randomAllergies = ['Penicillin', 'Shellfish', 'Pollen', 'None known'];

        const randomIdx = Math.floor(Math.random() * 4);

        html += `
          <label style="display:flex;align-items:flex-start;gap:12px;padding:16px;background:white;border:2px solid #e2e8f0;border-radius:8px;margin:12px 0;cursor:pointer;">
            <input type="checkbox" id="share-questionnaire-${idx}" data-q-idx="${idx}" checked style="margin-top:4px">
            <div style="flex:1">
              <div style="font-weight:600;color:#0d9488;margin-bottom:8px">üìù ${title}</div>
              <div class="auto-filled-banner" style="margin:12px 0">
                <div class="auto-filled-banner-icon">‚úì</div>
                <div class="auto-filled-banner-text">We found matching records. We have auto-filled your Intake Form below using data from your health records.</div>
              </div>
              <div class="questionnaire-form" id="q-form-${idx}">
        `;

        // Render each question based on the questionnaire structure
        if (questionnaire && questionnaire.item) {
          questionnaire.item.forEach((question, qIdx) => {
            const fieldId = `q-${idx}-${question.linkId}`;
            const isRequired = question.required ? ' <span style="color:#dc2626">*</span>' : '';

            html += `<div class="questionnaire-item">`;
            html += `<label for="${fieldId}">${question.text}${isRequired}</label>`;

            // Pre-fill with random realistic values
            let defaultValue = '';
            if (question.linkId === '1') defaultValue = randomNames[randomIdx];
            else if (question.linkId === '2') defaultValue = randomDates[randomIdx];
            else if (question.linkId === '3') defaultValue = randomConcerns[randomIdx];
            else if (question.linkId === '4') defaultValue = randomMeds[randomIdx];
            else if (question.linkId === '5') defaultValue = randomAllergies[randomIdx];

            const fieldClass = defaultValue ? 'auto-filled-field' : '';
            if (question.type === 'text') {
              html += `<textarea id="${fieldId}" rows="3" class="${fieldClass}">${defaultValue}</textarea>`;
            } else if (question.type === 'date') {
              html += `<input type="date" id="${fieldId}" value="${defaultValue}" class="${fieldClass}">`;
            } else {
              html += `<input type="text" id="${fieldId}" value="${defaultValue}" class="${fieldClass}">`;
            }

            html += `</div>`;
          });
        }

        html += `
              </div>
            </div>
          </label>
        `;
      });
      html += `</div>`; // Close section
    }

    html += `
      <div class="actions">
        <button class="btn-secondary" onclick="handleCancel()">Cancel</button>
        <button class="btn-primary" onclick="handleShare()">Share Selected Data</button>
      </div>
    `;

    document.getElementById('content').innerHTML = html;

    window.handleCancel = () => {
      window.close();
    };

    window.handleShare = () => {
      const responseItems = [];

      console.log('[Flexpa] Starting share process');
      console.log('[Flexpa] Request items:', requestItems);
      console.log('[Flexpa] State:', state);
      console.log('[Flexpa] Return URL:', returnUrl);

      // Check if insurance card should be shared
      const shareInsurance = document.getElementById('share-insurance')?.checked;
      const shareClinical = document.getElementById('share-clinical')?.checked;

      // Handle insurance card if selected
      const coverageRequests = requestItems.filter(item => item.type === 'fhir-profile' && item.resourceType === 'Coverage');
      if (shareInsurance && coverageRequests.length > 0) {
        console.log('[Flexpa] Adding insurance card');

        responseItems.push({
          requestIds: coverageRequests.map(r => r.id),
          type: 'fhir-resource',
          contentType: 'application/fhir+json;fhirVersion=4.0.1',
          label: 'Insurance Card',
          body: {
            resourceType: 'Coverage',
            id: 'coverage-1',
            status: 'active',
            subscriberId: 'W123456789',
            beneficiary: { reference: 'Patient/patient-1', display: 'Jane Doe' },
            payor: [{ display: 'Aetna' }],
            class: [
              { type: { coding: [{ code: 'group' }] }, value: 'TECH-2024' }
            ]
          }
        });
      }

      // Handle clinical summary if selected
      const patientRequests = requestItems.filter(item => item.type === 'fhir-profile' && item.resourceType === 'Patient');
      if (shareClinical && patientRequests.length > 0) {
        console.log('[Flexpa] Adding clinical summary');

        const entries = [
          {
            fullUrl: 'urn:uuid:patient-1',
            resource: {
              resourceType: 'Patient',
              id: 'patient-1',
              name: [{ text: 'Jane Doe', family: 'Doe', given: ['Jane'] }],
              birthDate: '1985-06-15'
            }
          },
          {
            fullUrl: 'urn:uuid:allergy-1',
            resource: { resourceType: 'AllergyIntolerance', id: 'allergy-1', patient: { reference: 'Patient/patient-1' }, code: { text: 'Penicillin' } }
          },
          {
            fullUrl: 'urn:uuid:med-1',
            resource: { resourceType: 'MedicationStatement', id: 'med-1', subject: { reference: 'Patient/patient-1' }, medicationCodeableConcept: { text: 'Lisinopril 10mg daily' } }
          },
          {
            fullUrl: 'urn:uuid:condition-1',
            resource: { resourceType: 'Condition', id: 'condition-1', subject: { reference: 'Patient/patient-1' }, code: { text: 'Essential Hypertension' } }
          }
        ];

        responseItems.push({
          requestIds: patientRequests.map(r => r.id),
          type: 'fhir-resource',
          contentType: 'application/fhir+json;fhirVersion=4.0.1',
          label: 'Health Summary',
          body: {
            resourceType: 'Bundle',
            type: 'collection',
            entry: entries
          }
        });
      }

      // Handle questionnaire requests
      const questionnaireRequests = requestItems.filter(item => item.type === 'fhir-questionnaire');
      questionnaireRequests.forEach((qItem, idx) => {
        const shareQuestionnaire = document.getElementById(`share-questionnaire-${idx}`)?.checked;
        if (!shareQuestionnaire) {
          console.log(`[Flexpa] Skipping questionnaire ${idx} (not selected)`);
          return;
        }

        console.log(`[Flexpa] Adding questionnaire ${idx}`);
        const questionnaire = qItem.questionnaire;
        const items = [];

        // Build response items from questionnaire structure
        if (questionnaire && questionnaire.item) {
          questionnaire.item.forEach((question) => {
            const fieldId = `q-${idx}-${question.linkId}`;
            const value = document.getElementById(fieldId)?.value || '';

            if (value) {
              const answer = question.type === 'date'
                ? [{ valueDate: value }]
                : [{ valueString: value }];

              items.push({
                linkId: question.linkId,
                text: question.text,
                answer: answer
              });
            }
          });
        }

        responseItems.push({
          requestIds: [qItem.id],
          type: 'fhir-questionnaire-response',
          contentType: 'application/fhir+json',
          label: questionnaire?.title || 'Questionnaire Response',
          questionnaire: qItem.questionnaireUrl || questionnaire?.id || 'inline',
          body: {
            resourceType: 'QuestionnaireResponse',
            questionnaire: questionnaire?.id,
            status: 'completed',
            authored: new Date().toISOString(),
            item: items
          }
        });
      });

      console.log('[Flexpa] Response items:', responseItems);

      const payload = {
        items: responseItems
      };

      const result = { v: 1, state, payload };
      console.log('[Flexpa] Result envelope:', result);

      const resB64 = b64u(te.encode(JSON.stringify(result)));
      console.log('[Flexpa] Encoded response (first 100 chars):', resB64.substring(0, 100));

      const returnURL = new URL(returnUrl);
      returnURL.hash = 'res=' + resB64;

      console.log('[Flexpa] Returning to:', returnURL.toString());
      console.log('[Flexpa] Response will be delivered via location change');
      location.href = returnURL.toString();
    };
  })();
  </script>
</body>
</html>
